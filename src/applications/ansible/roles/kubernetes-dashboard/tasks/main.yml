- name: Create temp directory
  file:
    path: "/tmp/{{ role_name }}"
    state: directory
  register: directory
  tags:
    - deploy
    - destroy

- name: Download manifest
  get_url:
    url: "https://raw.githubusercontent.com/kubernetes/dashboard/v{{ kubernetes_dashboard_version }}/aio/deploy/recommended.yaml"
    dest: "{{ directory.path }}/recommended.yml"
  register: manifest
  tags:
    - deploy
    - destroy

- name: Apply manifest
  k8s:
    src: "{{ manifest.dest }}"
    wait: yes
    state: present
  tags:
    - deploy

- name: Apply ingress
  k8s:
    definition:
      apiVersion: extensions/v1beta1
      kind: Ingress
      metadata:
        name: kubernetes-dashboard
        namespace: kubernetes-dashboard
        annotations:
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
      spec:
        rules:
          - host: kube.apps.fdavidson.net
            http:
              paths:
                - path: /
                  backend:
                    serviceName: kubernetes-dashboard
                    servicePort: 443
        tls:
          - hosts:
              - kube.apps.fdavidson.net
    state: present
  tags:
    - deploy

- name: Delete ingress
  k8s:
    api_version: extensions/v1beta1
    kind: Ingress
    name: kubernetes-dashboard
    namespace: kubernetes-dashboard
    state: absent
  tags:
    - destroy

- name: Delete manifest
  k8s:
    src: "{{ manifest.dest }}"
    state: absent
  tags:
    - destroy

- name: Delete temp directory
  file:
    path: "{{ directory.path }}"
    state: absent
  register: directory
  tags:
    - deploy
    - destroy
