- name: Create temp directory
  file:
    path: "/tmp/{{ role_name }}"
    state: directory
  register: directory
  tags:
    - deploy
    - destroy

- name: Download manifest
  get_url:
    url: "https://github.com/kubernetes-sigs/metrics-server/releases/download/v{{ metrics_server_version }}/components.yaml"
    dest: "{{ directory.path }}/components.yml"
  register: manifest
  tags:
    - deploy
    - destroy

- name: Apply manifest
  k8s:
    src: "{{ manifest.dest }}"
    state: present
  tags:
    - deploy

- name: Patch deployment
  k8s:
    definition:
      apiVersion: v1
      kind: Deployment
      metadata:
        name: metrics-server
        namespace: kube-system
      spec:
        template:
          spec:
            containers:
              - name: metrics-server
                args:
                  - --cert-dir=/tmp
                  - --secure-port=4443
                  - --kubelet-insecure-tls
                  - --kubelet-preferred-address-types=InternalIP
  tags:
    - deploy

- name: Delete manifest
  k8s:
    src: "{{ manifest.dest }}"
    state: absent
  tags:
    - destroy
